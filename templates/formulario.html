<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Portal de Facturas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card {
      max-width: 500px;
      margin: auto;
    }

    .bg-primary {
      background-color: #2771c2 !important;
    }
  </style>
</head>

<body class="bg-light">

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow">
          <div class="card-header bg-primary text-white text-center">
            <div class="card-header bg-primary text-white d-flex align-items-center">
              <img src="static/img/Logo_caiasa.jpg" alt="Logo" style="height: 50px; margin-right: 15px;">
              <h4 class="mb-0">Portal de facturas</h4>
            </div>
          </div>
          <div class="card-body">

            <!-- Flash messages -->
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="alert alert-info">
              <ul class="mb-0">
                {% for message in messages %}
                <li>{{ message }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% endwith %}

            <!-- ✅ Formulario corregido -->
            <form id="invoiceForm" method="POST" action="/" enctype="multipart/form-data">
              <div id="mensajeError"></div>

              <div class="mb-3">
                <label for="email" class="form-label">Correo electrónico:</label>
                <input type="email" class="form-control" name="email" id="email" placeholder="nombre@empresa.com" required>
              </div>

              <div class="mb-3">
                <label for="factura" class="form-label">Seleccionar Factura:</label>
                <input type="file" class="form-control" id="factura" name="factura" accept="application/pdf" required>
              </div>

              <div class="mb-3">
                <label for="orden" class="form-label">Seleccionar Orden de Compra:</label>
                <input type="file" class="form-control" id="orden" name="orden" accept="application/pdf" required>
              </div>

              <div class="mb-3">
                <label for="remision" class="form-label">Seleccionar Remisión/Actas:</label>
                <input type="file" class="form-control" id="remision" name="remision" accept="application/pdf" required>
              </div>

              <button type="submit" class="btn btn-success w-100">Enviar</button>
            </form>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    function mostrarAlerta(tipo, mensaje) {
      const mensajeError = document.getElementById('mensajeError');
      mensajeError.innerHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
          ${mensaje}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;

      setTimeout(() => {
        const alerta = mensajeError.querySelector(".alert");
        if (alerta) {
          alerta.classList.remove("show");
          setTimeout(() => alerta.remove(), 500);
        }
      }, 5000);
    }

    document.getElementById('invoiceForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const factura = document.getElementById('factura').files[0];
      const orden = document.getElementById('orden').files[0];
      const remision = document.getElementById('remision').files[0];

      if (!email) {
        mostrarAlerta("danger", "Por favor, ingresá un correo electrónico.");
        return;
      }

      if (!factura || !orden || !remision) {
        mostrarAlerta("danger", "Es obligatorio adjuntar los tres archivos: Factura, Orden de Compra y Remisión/Actas.");
        return;
      }

      const archivos = [factura, orden, remision].filter(Boolean);
      for (let archivo of archivos) {
        if (archivo.type !== "application/pdf" && !archivo.name.toLowerCase().endsWith(".pdf")) {
          mostrarAlerta("danger", `El archivo <strong>${archivo.name}</strong> no es un PDF válido.`);
          return;
        }
      }

      const formData = new FormData();
      formData.append('email', email);
      if (factura) formData.append('factura', factura);
      if (orden) formData.append('orden', orden);
      if (remision) formData.append('remision', remision);

      // ✅ Se envía al endpoint `/` seguro
      fetch("/", {
        method: 'POST',
        body: formData
      })
        .then(response => {
          if (response.ok) {
            mostrarAlerta("success", "Archivos enviados correctamente.");
            this.reset();
          } else {
            mostrarAlerta("danger", "Error al enviar los archivos.");
          }
        })
        .catch(error => {
          console.error(error);
          mostrarAlerta("danger", "Error en la conexión.");
        });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
