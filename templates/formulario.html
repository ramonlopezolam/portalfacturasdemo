<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portal de Facturas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card { max-width: 500px; margin: auto; }
    .bg-primary { background-color: #2771c2 !important; }
  </style>
</head>

<body class="bg-light">
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow">
          <div class="card-header bg-primary text-white d-flex align-items-center">
            <img src="static/img/Logo_caiasa.jpg" alt="Logo" style="height: 50px; margin-right: 15px;">
            <h4 class="mb-0">Portal de facturas</h4>
          </div>
          <div class="card-body">
            <form id="invoiceForm" enctype="multipart/form-data">
              <div id="mensajeError"></div>

              <div class="mb-3">
                <label for="email" class="form-label">Correo electrónico:</label>
                <input type="email" class="form-control" id="email" placeholder="nombre@empresa.com" required>
              </div>

              <div class="mb-3">
                <label for="factura" class="form-label">Seleccionar Factura:</label>
                <input type="file" class="form-control" id="factura" accept="application/pdf" required>
              </div>

              <div class="mb-3">
                <label for="orden" class="form-label">Seleccionar Orden de Compra:</label>
                <input type="file" class="form-control" id="orden" accept="application/pdf" required>
              </div>

              <div class="mb-3">
                <label for="remision" class="form-label">Seleccionar Remisión/Actas:</label>
                <input type="file" class="form-control" id="remision" accept="application/pdf" required>
              </div>

              <button type="submit" class="btn btn-success w-100">Enviar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    function mostrarAlerta(tipo, mensaje) {
      const mensajeError = document.getElementById('mensajeError');
      mensajeError.innerHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
          ${mensaje}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      setTimeout(() => {
        const alerta = mensajeError.querySelector(".alert");
        if (alerta) {
          alerta.classList.remove("show");
          setTimeout(() => alerta.remove(), 500);
        }
      }, 5000);
    }

    document.getElementById('invoiceForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const factura = document.getElementById('factura').files[0];
      const orden = document.getElementById('orden').files[0];
      const remision = document.getElementById('remision').files[0];

      if (!email || !factura || !orden || !remision) {
        mostrarAlerta("danger", "Todos los campos son obligatorios.");
        return;
      }

      const archivos = [factura, orden, remision];
      for (let archivo of archivos) {
        if (archivo.type !== "application/pdf" && !archivo.name.toLowerCase().endsWith(".pdf")) {
          mostrarAlerta("danger", `El archivo <strong>${archivo.name}</strong> no es un PDF válido.`);
          return;
        }
      }

      const formData = new FormData();
      formData.append('email', email);
      formData.append('factura', factura);
      formData.append('orden', orden);
      formData.append('remision', remision);

      fetch("/api/upload", {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          mostrarAlerta("success", "Archivos enviados correctamente.");
        } else {
          response.json().then(data => {
            mostrarAlerta("danger", "Error: " + (data.error || "Falló la carga"));
          });
        }
      })
      .catch(error => {
        mostrarAlerta("danger", "Error en la conexión.");
        console.error(error);
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
